<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>留下 | 有种🌹少年是MayDay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="JOS内核跟踪make qemu-gdb命令12345678910qemu-gdb: $(IMAGES) pre-qemu   @echo &quot;***&quot;   @echo &quot;*** Now run &amp;#x27;make gdb&amp;#x27;.&quot; 1&gt;&amp;2   @echo &quot;***&quot;   $(QEMU) $(QEMUOPTS) -S">
<meta property="og:type" content="article">
<meta property="og:title" content="留下">
<meta property="og:url" content="http://example.com/2021/12/17/%E7%95%99%E4%B8%8B/index.html">
<meta property="og:site_name" content="有种🌹少年是MayDay">
<meta property="og:description" content="JOS内核跟踪make qemu-gdb命令12345678910qemu-gdb: $(IMAGES) pre-qemu   @echo &quot;***&quot;   @echo &quot;*** Now run &amp;#x27;make gdb&amp;#x27;.&quot; 1&gt;&amp;2   @echo &quot;***&quot;   $(QEMU) $(QEMUOPTS) -S">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zivlnoff.github.io/graph/image-20211212103548408.png">
<meta property="og:image" content="https://zivlnoff.github.io/graph/image-20211210174140428.png">
<meta property="article:published_time" content="2021-12-17T02:29:22.000Z">
<meta property="article:modified_time" content="2021-12-17T02:37:48.714Z">
<meta property="article:author" content="ColvTzzi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zivlnoff.github.io/graph/image-20211212103548408.png">
  
    <link rel="alternate" href="/atom.xml" title="有种🌹少年是MayDay" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">有种🌹少年是MayDay</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-留下" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/17/%E7%95%99%E4%B8%8B/" class="article-date">
  <time class="dt-published" datetime="2021-12-17T02:29:22.000Z" itemprop="datePublished">2021-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      留下
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="JOS内核跟踪make-qemu-gdb命令"><a href="#JOS内核跟踪make-qemu-gdb命令" class="headerlink" title="JOS内核跟踪make qemu-gdb命令"></a>JOS内核跟踪make qemu-gdb命令</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">qemu-gdb: <span class="variable">$(IMAGES)</span> pre-qemu</span></span><br><span class="line">   @echo <span class="string">&quot;***&quot;</span></span><br><span class="line">   @echo <span class="string">&quot;*** Now run &#x27;make gdb&#x27;.&quot;</span> 1&gt;&amp;2</span><br><span class="line">   @echo <span class="string">&quot;***&quot;</span></span><br><span class="line">   <span class="variable">$(QEMU)</span> <span class="variable">$(QEMUOPTS)</span> -S</span><br><span class="line">      </span><br><span class="line">IMAGES = <span class="variable">$(OBJDIR)</span>/kern/kernel.img</span><br><span class="line">OBJDIR := obj</span><br><span class="line"></span><br><span class="line"><span class="section">pre-qemu: .gdbinit</span></span><br></pre></td></tr></table></figure>



<h2 id="gdbinit"><a href="#gdbinit" class="headerlink" title=".gdbinit"></a>.gdbinit</h2><p>GDB 在启动的时候会按一定的路径顺序(通常是先当前目录而后用户目录)寻找 .gdbinit 文件，一旦找到，就会自动执行里面的命令。这个功能允许用户把常用的一些命令放在这个文件里，这样就不用每次进入 gdb 后再去手动执行这些命令。事实上，.gdbinit 就是一个脚本，甚至可在里面把常用的若干 gdb命令序列定义成一个新命令，这样只要在 gdb 里面输入这个新命令就等于自动执行了被定义的那个命令序列。</p>
<p>另外，如果用户已经在 gdb 里后，再去修改 .gdbinit ，只要通过：</p>
<p>(gdb) source  ~/.gdbinit</p>
<p>便可以让那些新增加的改动生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">set $lastcs = -1</span><br><span class="line"></span><br><span class="line">define hook-stop	# 遇到断点或单步调试时,停顿时的钩子</span><br><span class="line">  # There doesn&#x27;t seem to be a good way to detect if we&#x27;re in 16- or</span><br><span class="line">  # 32-bit mode, but we always run with CS == 8 in 32-bit mode.</span><br><span class="line">  if $cs == 8 || $cs == 27	</span><br><span class="line">    if $lastcs != 8 &amp;&amp; $lastcs != 27</span><br><span class="line">      set architecture i386</span><br><span class="line">    end</span><br><span class="line">    x/i $pc</span><br><span class="line">  else</span><br><span class="line">    if $lastcs == -1 || $lastcs == 8 || $lastcs == 27</span><br><span class="line">      set architecture i8086</span><br><span class="line">    end</span><br><span class="line">    # Translate the segment:offset into a physical address</span><br><span class="line">    printf &quot;[%4x:%4x] &quot;, $cs, $eip</span><br><span class="line">    x/i $cs*16+$eip</span><br><span class="line">  end</span><br><span class="line">  set $lastcs = $cs</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">echo + target remote localhost:25601\n</span><br><span class="line">target remote localhost:25601</span><br><span class="line"></span><br><span class="line"># If this fails, it&#x27;s probably because your GDB doesn&#x27;t support ELF.</span><br><span class="line"># Look at the tools page at</span><br><span class="line">#  http://pdos.csail.mit.edu/6.828/2009/tools.html</span><br><span class="line"># for instructions on building GDB with ELF support.</span><br><span class="line">echo + symbol-file obj/kern/kernel\n</span><br><span class="line">symbol-file obj/kern/kernel</span><br></pre></td></tr></table></figure>

<h1 id="JOS手册"><a href="#JOS手册" class="headerlink" title="JOS手册"></a>JOS手册</h1><h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="类型操作"><a href="#类型操作" class="headerlink" title="类型操作"></a>类型操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NULL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NULL ((void*) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Represents true-or-false values</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">_Bool</span> <span class="keyword">bool</span>;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> <span class="literal">false</span>, <span class="literal">true</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Explicitly-sized versions of integer types</span></span><br><span class="line"><span class="keyword">typedef</span> __signed <span class="keyword">char</span> <span class="keyword">int8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">uint8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">short</span> <span class="keyword">int16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">uint16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">int32_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="keyword">uint32_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int64_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">uint64_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pointers and addresses are 32 bits long.</span></span><br><span class="line"><span class="comment">// We use pointer types to represent virtual addresses,</span></span><br><span class="line"><span class="comment">// uintptr_t to represent the numerical values of virtual addresses,</span></span><br><span class="line"><span class="comment">// and physaddr_t to represent physical addresses.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span> <span class="keyword">intptr_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">uintptr_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">physaddr_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Page numbers are 32 bits long.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">ppn_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// size_t is used for memory object sizes.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">size_t</span>;</span><br><span class="line"><span class="comment">// ssize_t is a signed version of ssize_t, used in case there might be an</span></span><br><span class="line"><span class="comment">// error return.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span> <span class="keyword">ssize_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// off_t is used for file offsets and lengths.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span> <span class="keyword">off_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Efficient min and max operations</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN(_a, _b)						\</span></span><br><span class="line"><span class="meta">(&#123;								\</span></span><br><span class="line"><span class="meta">	typeof(_a) __a = (_a);					\</span></span><br><span class="line"><span class="meta">	typeof(_b) __b = (_b);					\</span></span><br><span class="line"><span class="meta">	__a &lt;= __b ? __a : __b;					\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(_a, _b)						\</span></span><br><span class="line"><span class="meta">(&#123;								\</span></span><br><span class="line"><span class="meta">	typeof(_a) __a = (_a);					\</span></span><br><span class="line"><span class="meta">	typeof(_b) __b = (_b);					\</span></span><br><span class="line"><span class="meta">	__a &gt;= __b ? __a : __b;					\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rounding operations (efficient when n is a power of 2)</span></span><br><span class="line"><span class="comment">// Round down to the nearest multiple of n</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROUNDDOWN(a, n)						\</span></span><br><span class="line"><span class="meta">(&#123;								\</span></span><br><span class="line"><span class="meta">	uint32_t __a = (uint32_t) (a);				\</span></span><br><span class="line"><span class="meta">	(typeof(a)) (__a - __a % (n));				\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="comment">// Round up to the nearest multiple of n</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROUNDUP(a, n)						\</span></span><br><span class="line"><span class="meta">(&#123;								\</span></span><br><span class="line"><span class="meta">	uint32_t __n = (uint32_t) (n);				\</span></span><br><span class="line"><span class="meta">	(typeof(a)) (ROUNDDOWN((uint32_t) (a) + __n - 1, __n));	\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE(a)	(sizeof(a) / sizeof(a[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the offset of &#x27;member&#x27; relative to the beginning of a struct type</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(type, member)  ((size_t) (&amp;((type*)0)-&gt;member))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">	<span class="comment">// Kernel error codes -- keep in sync with list in lib/printfmt.c.</span></span><br><span class="line">	E_UNSPECIFIED	= <span class="number">1</span>,	<span class="comment">// Unspecified or unknown problem</span></span><br><span class="line">	E_BAD_ENV	,	<span class="comment">// Environment doesn&#x27;t exist or otherwise</span></span><br><span class="line">				<span class="comment">// cannot be used in requested action</span></span><br><span class="line">	E_INVAL		,	<span class="comment">// Invalid parameter</span></span><br><span class="line">	E_NO_MEM	,	<span class="comment">// Request failed due to memory shortage</span></span><br><span class="line">	E_NO_FREE_ENV	,	<span class="comment">// Attempt to create a new environment beyond</span></span><br><span class="line">				<span class="comment">// the maximum allowed</span></span><br><span class="line">	E_FAULT		,	<span class="comment">// Memory fault</span></span><br><span class="line"></span><br><span class="line">	MAXERROR</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">strnlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">strcpy</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">strncpy</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">strcat</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">strlcpy</span><span class="params">(<span class="keyword">char</span> *dst, <span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">strcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">strncmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">strchr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">char</span> c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">strfind</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">char</span> c)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">memset</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">int</span> c, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">const</span> <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">memmove</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">const</span> <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">memcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *s1, <span class="keyword">const</span> <span class="keyword">void</span> *s2, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">memfind</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *s, <span class="keyword">int</span> c, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span>   <span class="title">strtol</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">char</span> **endptr, <span class="keyword">int</span> base)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="打印操作"><a href="#打印操作" class="headerlink" title="打印操作"></a>打印操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/console.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">cputchar</span><span class="params">(<span class="keyword">int</span> c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">getchar</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">iscons</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib/printfmt.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">printfmt</span><span class="params">(<span class="keyword">void</span> (*putch)(<span class="keyword">int</span>, <span class="keyword">void</span>*), <span class="keyword">void</span> *putdat, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">vprintfmt</span><span class="params">(<span class="keyword">void</span> (*putch)(<span class="keyword">int</span>, <span class="keyword">void</span>*), <span class="keyword">void</span> *putdat, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">snprintf</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">vsnprintf</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib/printf.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">cprintf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">vcprintf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib/fprintf.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">fprintf</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>    <span class="title">vfprintf</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib/readline.c</span></span><br><span class="line"><span class="function"><span class="keyword">char</span>*  <span class="title">readline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span></span>;</span><br></pre></td></tr></table></figure>

<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><h2 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file contains definitions for memory management in our OS,</span></span><br><span class="line"><span class="comment"> * which are relevant to both the kernel and user-mode software.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global descriptor numbers</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GD_KT     0x08     <span class="comment">// kernel text</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GD_KD     0x10     <span class="comment">// kernel data</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GD_UT     0x18     <span class="comment">// user text</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GD_UD     0x20     <span class="comment">// user data</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GD_TSS0   0x28     <span class="comment">// Task segment selector for CPU 0</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Virtual memory map:                                Permissions</span></span><br><span class="line"><span class="comment"> *                                                    kernel/user</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    4 Gig --------&gt;  +------------------------------+</span></span><br><span class="line"><span class="comment"> *                     |                              | RW/--</span></span><br><span class="line"><span class="comment"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"><span class="comment"> *                     :              .               :</span></span><br><span class="line"><span class="comment"> *                     :              .               :</span></span><br><span class="line"><span class="comment"> *                     :              .               :</span></span><br><span class="line"><span class="comment"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--</span></span><br><span class="line"><span class="comment"> *                     |                              | RW/--</span></span><br><span class="line"><span class="comment"> *                     |   Remapped Physical Memory   | RW/--</span></span><br><span class="line"><span class="comment"> *                     |                              | RW/--</span></span><br><span class="line"><span class="comment"> *    KERNBASE, ----&gt;  +------------------------------+ 0xf0000000      --+</span></span><br><span class="line"><span class="comment"> *    KSTACKTOP        |     CPU0&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span></span><br><span class="line"><span class="comment"> *                     | - - - - - - - - - - - - - - -|                   |</span></span><br><span class="line"><span class="comment"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span></span><br><span class="line"><span class="comment"> *                     +------------------------------+                   |</span></span><br><span class="line"><span class="comment"> *                     |     CPU1&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span></span><br><span class="line"><span class="comment"> *                     | - - - - - - - - - - - - - - -|                 PTSIZE</span></span><br><span class="line"><span class="comment"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span></span><br><span class="line"><span class="comment"> *                     +------------------------------+                   |</span></span><br><span class="line"><span class="comment"> *                     :              .               :                   |</span></span><br><span class="line"><span class="comment"> *                     :              .               :                   |</span></span><br><span class="line"><span class="comment"> *    MMIOLIM ------&gt;  +------------------------------+ 0xefc00000      --+</span></span><br><span class="line"><span class="comment"> *                     |       Memory-mapped I/O      | RW/--  PTSIZE</span></span><br><span class="line"><span class="comment"> * ULIM, MMIOBASE --&gt;  +------------------------------+ 0xef800000</span></span><br><span class="line"><span class="comment"> *                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE</span></span><br><span class="line"><span class="comment"> *    UVPT      ----&gt;  +------------------------------+ 0xef400000</span></span><br><span class="line"><span class="comment"> *                     |          RO PAGES            | R-/R-  PTSIZE</span></span><br><span class="line"><span class="comment"> *    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span></span><br><span class="line"><span class="comment"> *                     |           RO ENVS            | R-/R-  PTSIZE</span></span><br><span class="line"><span class="comment"> * UTOP,UENVS ------&gt;  +------------------------------+ 0xeec00000</span></span><br><span class="line"><span class="comment"> * UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE</span></span><br><span class="line"><span class="comment"> *                     +------------------------------+ 0xeebff000</span></span><br><span class="line"><span class="comment"> *                     |       Empty Memory (*)       | --/--  PGSIZE</span></span><br><span class="line"><span class="comment"> *    USTACKTOP  ---&gt;  +------------------------------+ 0xeebfe000</span></span><br><span class="line"><span class="comment"> *                     |      Normal User Stack       | RW/RW  PGSIZE</span></span><br><span class="line"><span class="comment"> *                     +------------------------------+ 0xeebfd000</span></span><br><span class="line"><span class="comment"> *                     |                              |</span></span><br><span class="line"><span class="comment"> *                     |                              |</span></span><br><span class="line"><span class="comment"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"><span class="comment"> *                     .                              .</span></span><br><span class="line"><span class="comment"> *                     .                              .</span></span><br><span class="line"><span class="comment"> *                     .                              .</span></span><br><span class="line"><span class="comment"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|</span></span><br><span class="line"><span class="comment"> *                     |     Program Data &amp; Heap      |</span></span><br><span class="line"><span class="comment"> *    UTEXT --------&gt;  +------------------------------+ 0x00800000</span></span><br><span class="line"><span class="comment"> *    PFTEMP -------&gt;  |       Empty Memory (*)       |        PTSIZE</span></span><br><span class="line"><span class="comment"> *                     |                              |</span></span><br><span class="line"><span class="comment"> *    UTEMP --------&gt;  +------------------------------+ 0x00400000      --+</span></span><br><span class="line"><span class="comment"> *                     |       Empty Memory (*)       |                   |</span></span><br><span class="line"><span class="comment"> *                     | - - - - - - - - - - - - - - -|                   |</span></span><br><span class="line"><span class="comment"> *                     |  User STAB Data (optional)   |                 PTSIZE</span></span><br><span class="line"><span class="comment"> *    USTABDATA ----&gt;  +------------------------------+ 0x00200000        |</span></span><br><span class="line"><span class="comment"> *                     |       Empty Memory (*)       |                   |</span></span><br><span class="line"><span class="comment"> *    0 ------------&gt;  +------------------------------+                 --+</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span></span><br><span class="line"><span class="comment"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span></span><br><span class="line"><span class="comment"> *     there if desired.  JOS user programs map pages temporarily at UTEMP.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// All physical memory mapped at this address</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    KERNBASE   0xF0000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// At IOPHYSMEM (640K) there is a 384K hole for I/O.  From the kernel,</span></span><br><span class="line"><span class="comment">// IOPHYSMEM can be addressed at KERNBASE + IOPHYSMEM.  The hole ends</span></span><br><span class="line"><span class="comment">// at physical address EXTPHYSMEM.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOPHYSMEM  0x0A0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXTPHYSMEM 0x100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kernel stack.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KSTACKTOP  KERNBASE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KSTKSIZE   (8*PGSIZE)        <span class="comment">// size of a kernel stack</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KSTKGAP       (8*PGSIZE)        <span class="comment">// size of a kernel stack guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory-mapped IO.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MMIOLIM       (KSTACKTOP - PTSIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MMIOBASE   (MMIOLIM - PTSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ULIM      (MMIOBASE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * User read-only mappings! Anything below here til UTOP are readonly to user.</span></span><br><span class="line"><span class="comment"> * They are global pages mapped in at env allocation time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// User read-only virtual page table (see &#x27;uvpt&#x27; below)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UVPT      (ULIM - PTSIZE)</span></span><br><span class="line"><span class="comment">// Read-only copies of the Page structures</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UPAGES    (UVPT - PTSIZE)</span></span><br><span class="line"><span class="comment">// Read-only copies of the global env structures</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UENVS     (UPAGES - PTSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Top of user VM. User can manipulate VA from UTOP-1 and down!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Top of user-accessible VM</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UTOP      UENVS</span></span><br><span class="line"><span class="comment">// Top of one-page user exception stack</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UXSTACKTOP UTOP</span></span><br><span class="line"><span class="comment">// Next page left invalid to guard against exception stack overflow; then:</span></span><br><span class="line"><span class="comment">// Top of normal user stack</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USTACKTOP  (UTOP - 2*PGSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Where user programs generally begin</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UTEXT     (2*PTSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Used for temporary page mappings.  Typed &#x27;void*&#x27; for convenience</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UTEMP     ((void*) PTSIZE)</span></span><br><span class="line"><span class="comment">// Used for temporary page mappings for the user page-fault handler</span></span><br><span class="line"><span class="comment">// (should not conflict with other temporary page mappings)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFTEMP    (UTEMP + PTSIZE - PGSIZE)</span></span><br><span class="line"><span class="comment">// The location of the user-level STABS data structure</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USTABDATA  (PTSIZE / 2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">pte_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">pde_t</span>;</span><br></pre></td></tr></table></figure>

<h2 id="MMU"><a href="#MMU" class="headerlink" title="MMU"></a>MMU</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file contains definitions for the x86 memory management unit (MMU),</span></span><br><span class="line"><span class="comment"> * including paging- and segmentation-related data structures and constants,</span></span><br><span class="line"><span class="comment"> * the %cr0, %cr4, and %eflags registers, and traps.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Part 1.  Paging data structures and constants.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A linear address &#x27;la&#x27; has a three-part structure as follows:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// +--------10------+-------10-------+---------12----------+</span></span><br><span class="line"><span class="comment">// | Page Directory |   Page Table   | Offset within Page  |</span></span><br><span class="line"><span class="comment">// |      Index     |      Index     |                     |</span></span><br><span class="line"><span class="comment">// +----------------+----------------+---------------------+</span></span><br><span class="line"><span class="comment">//  \--- PDX(la) --/ \--- PTX(la) --/ \---- PGOFF(la) ----/</span></span><br><span class="line"><span class="comment">//  \---------- PGNUM(la) ----------/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The PDX, PTX, PGOFF, and PGNUM macros decompose linear addresses as shown.</span></span><br><span class="line"><span class="comment">// To construct a linear address la from PDX(la), PTX(la), and PGOFF(la),</span></span><br><span class="line"><span class="comment">// use PGADDR(PDX(la), PTX(la), PGOFF(la)).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// page number field of address</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGNUM(la)  (((uintptr_t) (la)) &gt;&gt; PTXSHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// page directory index</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PDX(la)       ((((uintptr_t) (la)) &gt;&gt; PDXSHIFT) &amp; 0x3FF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// page table index</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTX(la)       ((((uintptr_t) (la)) &gt;&gt; PTXSHIFT) &amp; 0x3FF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// offset in page</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGOFF(la)  (((uintptr_t) (la)) &amp; 0xFFF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// construct linear address from indexes and offset</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGADDR(d, t, o)    ((void*) ((d) &lt;&lt; PDXSHIFT | (t) &lt;&lt; PTXSHIFT | (o)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Page directory and page table constants.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NPDENTRIES 1024      <span class="comment">// page directory entries per page directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NPTENTRIES 1024      <span class="comment">// page table entries per page table</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGSIZE    4096      <span class="comment">// bytes mapped by a page</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGSHIFT       12    <span class="comment">// log2(PGSIZE)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTSIZE    (PGSIZE*NPTENTRIES) <span class="comment">// bytes mapped by a page directory entry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTSHIFT       22    <span class="comment">// log2(PTSIZE)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTXSHIFT   12    <span class="comment">// offset of PTX in a linear address</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PDXSHIFT   22    <span class="comment">// offset of PDX in a linear address</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Page table/directory entry flags.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_P     0x001  <span class="comment">// Present</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_W     0x002  <span class="comment">// Writeable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_U     0x004  <span class="comment">// User</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_PWT       0x008  <span class="comment">// Write-Through</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_PCD       0x010  <span class="comment">// Cache-Disable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_A     0x020  <span class="comment">// Accessed</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_D     0x040  <span class="comment">// Dirty</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_PS    0x080  <span class="comment">// Page Size</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_G     0x100  <span class="comment">// Global</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The PTE_AVAIL bits aren&#x27;t used by the kernel or interpreted by the</span></span><br><span class="line"><span class="comment">// hardware, so user processes are allowed to set them arbitrarily.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_AVAIL  0xE00  <span class="comment">// Available for software use</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Flags in PTE_SYSCALL may be used in system calls.  (Others may not.)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_SYSCALL    (PTE_AVAIL | PTE_P | PTE_W | PTE_U)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Address in page table or page directory entry</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_ADDR(pte)  ((physaddr_t) (pte) &amp; ~0xFFF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Control Register flags</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PE    0x00000001 <span class="comment">// Protection Enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_MP    0x00000002 <span class="comment">// Monitor coProcessor</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_EM    0x00000004 <span class="comment">// Emulation</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_TS    0x00000008 <span class="comment">// Task Switched</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_ET    0x00000010 <span class="comment">// Extension Type</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NE    0x00000020 <span class="comment">// Numeric Errror</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_WP    0x00010000 <span class="comment">// Write Protect</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_AM    0x00040000 <span class="comment">// Alignment Mask</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NW    0x20000000 <span class="comment">// Not Writethrough</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_CD    0x40000000 <span class="comment">// Cache Disable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PG    0x80000000 <span class="comment">// Paging</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_PCE       0x00000100 <span class="comment">// Performance counter enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_MCE       0x00000040 <span class="comment">// Machine Check Enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_PSE       0x00000010 <span class="comment">// Page Size Extensions</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_DE    0x00000008 <span class="comment">// Debugging Extensions</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_TSD       0x00000004 <span class="comment">// Time Stamp Disable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_PVI       0x00000002 <span class="comment">// Protected-Mode Virtual Interrupts</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_VME       0x00000001 <span class="comment">// V86 Mode Extensions</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Eflags register</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_CF     0x00000001 <span class="comment">// Carry Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_PF     0x00000004 <span class="comment">// Parity Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_AF     0x00000010 <span class="comment">// Auxiliary carry Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_ZF     0x00000040 <span class="comment">// Zero Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_SF     0x00000080 <span class="comment">// Sign Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_TF     0x00000100 <span class="comment">// Trap Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IF     0x00000200 <span class="comment">// Interrupt Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_DF     0x00000400 <span class="comment">// Direction Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_OF     0x00000800 <span class="comment">// Overflow Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IOPL_MASK   0x00003000 <span class="comment">// I/O Privilege Level bitmask</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IOPL_0  0x00000000 <span class="comment">//   IOPL == 0</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IOPL_1  0x00001000 <span class="comment">//   IOPL == 1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IOPL_2  0x00002000 <span class="comment">//   IOPL == 2</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_IOPL_3  0x00003000 <span class="comment">//   IOPL == 3</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_NT     0x00004000 <span class="comment">// Nested Task</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_RF     0x00010000 <span class="comment">// Resume Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_VM     0x00020000 <span class="comment">// Virtual 8086 mode</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_AC     0x00040000 <span class="comment">// Alignment Check</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_VIF    0x00080000 <span class="comment">// Virtual Interrupt Flag</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_VIP    0x00100000 <span class="comment">// Virtual Interrupt Pending</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FL_ID     0x00200000 <span class="comment">// ID flag</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Page fault error codes</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FEC_PR    0x1    <span class="comment">// Page fault caused by protection violation</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FEC_WR    0x2    <span class="comment">// Page fault caused by a write</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FEC_U     0x4    <span class="comment">// Page fault occured while in user mode</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Part 2.  Segmentation data structures and constants.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ASSEMBLER__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macros to build GDT entries in assembly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG_NULL                  \</span></span><br><span class="line"><span class="meta">   .word 0, 0;                   \</span></span><br><span class="line"><span class="meta">   .byte 0, 0, 0, 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG(type,base,lim)             \</span></span><br><span class="line"><span class="meta">   .word (((lim) &gt;&gt; 12) &amp; 0xffff), ((base) &amp; 0xffff); \</span></span><br><span class="line"><span class="meta">   .byte (((base) &gt;&gt; 16) &amp; 0xff), (0x90 | (type)),       \</span></span><br><span class="line"><span class="meta">      (0xC0 | (((lim) &gt;&gt; 28) &amp; 0xf)), (((base) &gt;&gt; 24) &amp; 0xff)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  <span class="comment">// not __ASSEMBLER__</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inc/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Segment Descriptors</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Segdesc</span> &#123;</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_lim_15_0 : <span class="number">16</span>;  <span class="comment">// Low bits of segment limit</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_base_15_0 : <span class="number">16</span>; <span class="comment">// Low bits of segment base address</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_base_23_16 : <span class="number">8</span>; <span class="comment">// Middle bits of segment base address</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_type : <span class="number">4</span>;       <span class="comment">// Segment type (see STS_ constants)</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_s : <span class="number">1</span>;          <span class="comment">// 0 = system, 1 = application</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_dpl : <span class="number">2</span>;        <span class="comment">// Descriptor Privilege Level</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_p : <span class="number">1</span>;          <span class="comment">// Present</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_lim_19_16 : <span class="number">4</span>;  <span class="comment">// High bits of segment limit</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_avl : <span class="number">1</span>;        <span class="comment">// Unused (available for software use)</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_rsv1 : <span class="number">1</span>;       <span class="comment">// Reserved</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_db : <span class="number">1</span>;         <span class="comment">// 0 = 16-bit segment, 1 = 32-bit segment</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_g : <span class="number">1</span>;          <span class="comment">// Granularity: limit scaled by 4K when set</span></span><br><span class="line">   <span class="keyword">unsigned</span> sd_base_31_24 : <span class="number">8</span>; <span class="comment">// High bits of segment base address</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Null segment</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG_NULL   &#123; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 &#125;</span></span><br><span class="line"><span class="comment">// Segment that is loadable but faults when used</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG_FAULT  &#123; 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0 &#125;</span></span><br><span class="line"><span class="comment">// Normal segment</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG(type, base, lim, dpl)              \</span></span><br><span class="line"><span class="meta">&#123; ((lim) &gt;&gt; 12) &amp; 0xffff, (base) &amp; 0xffff, ((base) &gt;&gt; 16) &amp; 0xff,  \</span></span><br><span class="line"><span class="meta">    type, 1, dpl, 1, (unsigned) (lim) &gt;&gt; 28, 0, 0, 1, 1,      \</span></span><br><span class="line"><span class="meta">    (unsigned) (base) &gt;&gt; 24 &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG16(type, base, lim, dpl) (struct Segdesc)         \</span></span><br><span class="line"><span class="meta">&#123; (lim) &amp; 0xffff, (base) &amp; 0xffff, ((base) &gt;&gt; 16) &amp; 0xff,     \</span></span><br><span class="line"><span class="meta">    type, 1, dpl, 1, (unsigned) (lim) &gt;&gt; 16, 0, 0, 1, 0,      \</span></span><br><span class="line"><span class="meta">    (unsigned) (base) &gt;&gt; 24 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__ASSEMBLER__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Application segment type bits</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_X     0x8        <span class="comment">// Executable segment</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_E     0x4        <span class="comment">// Expand down (non-executable segments)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_C     0x4        <span class="comment">// Conforming code segment (executable only)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_W     0x2        <span class="comment">// Writeable (non-executable segments)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_R     0x2        <span class="comment">// Readable (executable segments)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STA_A     0x1        <span class="comment">// Accessed</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// System segment type bits</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_T16A   0x1        <span class="comment">// Available 16-bit TSS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_LDT       0x2        <span class="comment">// Local Descriptor Table</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_T16B   0x3        <span class="comment">// Busy 16-bit TSS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_CG16   0x4        <span class="comment">// 16-bit Call Gate</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_TG    0x5        <span class="comment">// Task Gate / Coum Transmitions</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_IG16   0x6        <span class="comment">// 16-bit Interrupt Gate</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_TG16   0x7        <span class="comment">// 16-bit Trap Gate</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_T32A   0x9        <span class="comment">// Available 32-bit TSS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_T32B   0xB        <span class="comment">// Busy 32-bit TSS</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_CG32   0xC        <span class="comment">// 32-bit Call Gate</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_IG32   0xE        <span class="comment">// 32-bit Interrupt Gate</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STS_TG32   0xF        <span class="comment">// 32-bit Trap Gate</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Part 3.  Traps.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Task state segment format (as described by the Pentium architecture book)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Taskstate</span> &#123;</span></span><br><span class="line">   <span class="keyword">uint32_t</span> ts_link;  <span class="comment">// Old ts selector</span></span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_esp0; <span class="comment">// Stack pointers and segment selectors</span></span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ss0;   <span class="comment">//   after an increase in privilege level</span></span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding1;</span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_esp1;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ss1;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding2;</span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_esp2;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ss2;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding3;</span><br><span class="line">   <span class="keyword">physaddr_t</span> ts_cr3; <span class="comment">// Page directory base</span></span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_eip;  <span class="comment">// Saved state from last task switch</span></span><br><span class="line">   <span class="keyword">uint32_t</span> ts_eflags;</span><br><span class="line">   <span class="keyword">uint32_t</span> ts_eax;   <span class="comment">// More saved state (registers)</span></span><br><span class="line">   <span class="keyword">uint32_t</span> ts_ecx;</span><br><span class="line">   <span class="keyword">uint32_t</span> ts_edx;</span><br><span class="line">   <span class="keyword">uint32_t</span> ts_ebx;</span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_esp;</span><br><span class="line">   <span class="keyword">uintptr_t</span> ts_ebp;</span><br><span class="line">   <span class="keyword">uint32_t</span> ts_esi;</span><br><span class="line">   <span class="keyword">uint32_t</span> ts_edi;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_es;       <span class="comment">// Even more saved state (segment selectors)</span></span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding4;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_cs;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding5;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ss;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding6;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ds;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding7;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_fs;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding8;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_gs;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding9;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_ldt;</span><br><span class="line">   <span class="keyword">uint16_t</span> ts_padding10;</span><br><span class="line">   <span class="keyword">uint16_t</span> <span class="keyword">ts_t</span>;    <span class="comment">// Trap on task switch</span></span><br><span class="line">   <span class="keyword">uint16_t</span> ts_iomb;  <span class="comment">// I/O map base address</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gate descriptors for interrupts and traps</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Gatedesc</span> &#123;</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_off_15_0 : <span class="number">16</span>;   <span class="comment">// low 16 bits of offset in segment</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_sel : <span class="number">16</span>;        <span class="comment">// segment selector</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_args : <span class="number">5</span>;        <span class="comment">// # args, 0 for interrupt/trap gates</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_rsv1 : <span class="number">3</span>;        <span class="comment">// reserved(should be zero I guess)</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_type : <span class="number">4</span>;        <span class="comment">// type(STS_&#123;TG,IG32,TG32&#125;)</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_s : <span class="number">1</span>;           <span class="comment">// must be 0 (system)</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_dpl : <span class="number">2</span>;         <span class="comment">// descriptor(meaning new) privilege level</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_p : <span class="number">1</span>;           <span class="comment">// Present</span></span><br><span class="line">   <span class="keyword">unsigned</span> gd_off_31_16 : <span class="number">16</span>;  <span class="comment">// high bits of offset in segment</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up a normal interrupt/trap gate descriptor.</span></span><br><span class="line"><span class="comment">// - istrap: 1 for a trap (= exception) gate, 0 for an interrupt gate.</span></span><br><span class="line">    <span class="comment">//   see section 9.6.1.3 of the i386 reference: &quot;The difference between</span></span><br><span class="line">    <span class="comment">//   an interrupt gate and a trap gate is in the effect on IF (the</span></span><br><span class="line">    <span class="comment">//   interrupt-enable flag). An interrupt that vectors through an</span></span><br><span class="line">    <span class="comment">//   interrupt gate resets IF, thereby preventing other interrupts from</span></span><br><span class="line">    <span class="comment">//   interfering with the current interrupt handler. A subsequent IRET</span></span><br><span class="line">    <span class="comment">//   instruction restores IF to the value in the EFLAGS image on the</span></span><br><span class="line">    <span class="comment">//   stack. An interrupt through a trap gate does not change IF.&quot;</span></span><br><span class="line"><span class="comment">// - sel: Code segment selector for interrupt/trap handler</span></span><br><span class="line"><span class="comment">// - off: Offset in code segment for interrupt/trap handler</span></span><br><span class="line"><span class="comment">// - dpl: Descriptor Privilege Level -</span></span><br><span class="line"><span class="comment">//   the privilege level required for software to invoke</span></span><br><span class="line"><span class="comment">//   this interrupt/trap gate explicitly using an int instruction.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SETGATE(gate, istrap, sel, off, dpl)         \</span></span><br><span class="line"><span class="meta">&#123;                       \</span></span><br><span class="line"><span class="meta">   (gate).gd_off_15_0 = (uint32_t) (off) &amp; 0xffff;       \</span></span><br><span class="line"><span class="meta">   (gate).gd_sel = (sel);             \</span></span><br><span class="line"><span class="meta">   (gate).gd_args = 0;                \</span></span><br><span class="line"><span class="meta">   (gate).gd_rsv1 = 0;                \</span></span><br><span class="line"><span class="meta">   (gate).gd_type = (istrap) ? STS_TG32 : STS_IG32;   \</span></span><br><span class="line"><span class="meta">   (gate).gd_s = 0;               \</span></span><br><span class="line"><span class="meta">   (gate).gd_dpl = (dpl);             \</span></span><br><span class="line"><span class="meta">   (gate).gd_p = 1;               \</span></span><br><span class="line"><span class="meta">   (gate).gd_off_31_16 = (uint32_t) (off) &gt;&gt; 16;     \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up a call gate descriptor.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SETCALLGATE(gate, sel, off, dpl)                       \</span></span><br><span class="line"><span class="meta">&#123;                       \</span></span><br><span class="line"><span class="meta">   (gate).gd_off_15_0 = (uint32_t) (off) &amp; 0xffff;       \</span></span><br><span class="line"><span class="meta">   (gate).gd_sel = (sel);             \</span></span><br><span class="line"><span class="meta">   (gate).gd_args = 0;                \</span></span><br><span class="line"><span class="meta">   (gate).gd_rsv1 = 0;                \</span></span><br><span class="line"><span class="meta">   (gate).gd_type = STS_CG32;          \</span></span><br><span class="line"><span class="meta">   (gate).gd_s = 0;               \</span></span><br><span class="line"><span class="meta">   (gate).gd_dpl = (dpl);             \</span></span><br><span class="line"><span class="meta">   (gate).gd_p = 1;               \</span></span><br><span class="line"><span class="meta">   (gate).gd_off_31_16 = (uint32_t) (off) &gt;&gt; 16;     \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pseudo-descriptors used for LGDT, LLDT and LIDT instructions.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pseudodesc</span> &#123;</span></span><br><span class="line">   <span class="keyword">uint16_t</span> pd_lim;      <span class="comment">// Limit</span></span><br><span class="line">   <span class="keyword">uint32_t</span> pd_base;     <span class="comment">// Base address</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>

<h1 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h1><h2 id="assignment"><a href="#assignment" class="headerlink" title="assignment"></a>assignment</h2><ul>
<li>物理内存分配</li>
<li>虚拟内存映射</li>
</ul>
<p><img src="https://zivlnoff.github.io/graph/image-20211212103548408.png"></p>
<h2 id="Physical-Page-Management"><a href="#Physical-Page-Management" class="headerlink" title="Physical Page Management"></a>Physical Page Management</h2><h2 id="Virtual-memory-map"><a href="#Virtual-memory-map" class="headerlink" title="Virtual memory map"></a>Virtual memory map</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Virtual memory map:                                Permissions</span><br><span class="line"> *                                                    kernel/user</span><br><span class="line"> *</span><br><span class="line"> * </span><br><span class="line"> *</span><br><span class="line"> *    4 Gig --------&gt;  +------------------------------+</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     |   Remapped Physical Memory   | RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *    KERNBASE, ----&gt;  +------------------------------+ 0xf0000000      --+</span><br><span class="line"> *    KSTACKTOP        |     CPU0&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     |     CPU1&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                 PTSIZE</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *    MMIOLIM ------&gt;  +------------------------------+ 0xefc00000      --+</span><br><span class="line"> *                     |     </span><br><span class="line"> Memory-mapped I/O      | RW/--  PTSIZE</span><br><span class="line"> * ULIM, MMIOBASE --&gt;  +------------------------------+ 0xef800000</span><br><span class="line"> *                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE</span><br><span class="line"> *    UVPT      ----&gt;  +------------------------------+ 0xef400000</span><br><span class="line"> *                     |          RO PAGES            | R-/R-  PTSIZE</span><br><span class="line"> *    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span><br><span class="line"> *                     |           RO ENVS            | R-/R-  PTSIZE</span><br><span class="line"> * UTOP,UENVS ------&gt;  +------------------------------+ 0xeec00000</span><br><span class="line"> * UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebff000</span><br><span class="line"> *                     |       Empty Memory (*)       | --/--  PGSIZE</span><br><span class="line"> *    USTACKTOP  ---&gt;  +------------------------------+ 0xeebfe000</span><br><span class="line"> *                     |      Normal User Stack       | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebfd000</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|</span><br><span class="line"> *                     |     Program Data &amp; Heap      |</span><br><span class="line"> *    UTEXT --------&gt;  +------------------------------+ 0x00800000</span><br><span class="line"> *    PFTEMP -------&gt;  |       Empty Memory (*)       |        PTSIZE</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *    UTEMP --------&gt;  +------------------------------+ 0x00400000      --+</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |  User STAB Data (optional)   |                 PTSIZE</span><br><span class="line"> *    USTABDATA ----&gt;  +------------------------------+ 0x00200000        |</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *    0 ------------&gt;  +------------------------------+                 --+</span><br><span class="line"> *</span><br><span class="line"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="line"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="line"> *     there if desired.  JOS user programs map pages temporarily at UTEMP.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>

<h1 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h1><h4 id="下断点执行到将执行权移交给内核"><a href="#下断点执行到将执行权移交给内核" class="headerlink" title="下断点执行到将执行权移交给内核"></a>下断点执行到将执行权移交给内核</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b *<span class="number">0x10000c</span></span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x10000c</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">The target architecture is <span class="built_in">set</span> to <span class="string">&quot;i386&quot;</span>.</span><br><span class="line">=&gt; <span class="number">0x10000c</span>:    movw   $<span class="number">0x1234</span>,<span class="number">0x472</span></span><br></pre></td></tr></table></figure>

<h4 id="查看寄存器，此时ebp-0x7bf8，与进入bootmain-方法时相同"><a href="#查看寄存器，此时ebp-0x7bf8，与进入bootmain-方法时相同" class="headerlink" title="查看寄存器，此时ebp = 0x7bf8，与进入bootmain()方法时相同"></a>查看寄存器，此时ebp = 0x7bf8，与进入bootmain()方法时相同</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info registers </span><br><span class="line">eax            <span class="number">0xffffff40</span>          <span class="number">-192</span></span><br><span class="line">ecx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">edx            <span class="number">0xffffff40</span>          <span class="number">-192</span></span><br><span class="line">ebx            <span class="number">0x10074</span>             <span class="number">65652</span></span><br><span class="line">esp            <span class="number">0x7bec</span>              <span class="number">0x7bec</span></span><br><span class="line">ebp            <span class="number">0x7bf8</span>              <span class="number">0x7bf8</span></span><br><span class="line">esi            <span class="number">0x10074</span>             <span class="number">65652</span></span><br><span class="line">edi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">eip            <span class="number">0x10000c</span>            <span class="number">0x10000c</span></span><br><span class="line">eflags         <span class="number">0x46</span>                [ PF ZF ]</span><br><span class="line">cs             <span class="number">0x8</span>                 <span class="number">8</span></span><br><span class="line">ss             <span class="number">0x10</span>                <span class="number">16</span></span><br><span class="line">ds             <span class="number">0x10</span>                <span class="number">16</span></span><br><span class="line">es             <span class="number">0x10</span>                <span class="number">16</span></span><br><span class="line">fs             <span class="number">0x10</span>                <span class="number">16</span></span><br><span class="line">gs             <span class="number">0x10</span>                <span class="number">16</span></span><br></pre></td></tr></table></figure>

<h3 id="解读内核entry函数"><a href="#解读内核entry函数" class="headerlink" title="解读内核entry函数"></a>解读内核entry函数</h3><h4 id="虚拟地址映射"><a href="#虚拟地址映射" class="headerlink" title="虚拟地址映射"></a>虚拟地址映射</h4><ul>
<li><p>进入内核之前，bootmain装载了kernel，装载位置是由生成的kernel文件确定</p>
</li>
<li><p>```c<br>C02C8343LVDL:lab1 alsc$ objdump -h obj/kern/kernel</p>
<p>obj/kern/kernel:        file format elf32-i386</p>
<p>Sections:<br>Idx Name            Size     VMA      LMA      Type<br>  0                 00000000 00000000 00000000<br>  1 .text           000017a8 f0100000 00100000 TEXT<br>  2 .rodata         00000714 f01017c0 001017c0 DATA<br>  3 .stab           00003829 f0101ed4 00101ed4 DATA<br>  4 .stabstr        00001583 f01056fd 001056fd<br>  5 .data           0000a300 f0107000 00107000 DATA<br>  6 .bss            00000661 f0111300 00111300 DATA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 而kernel文件的prohdr是由.ld文件去链接，链接是针对虚拟地址的，load针对物理地址</span><br><span class="line"></span><br><span class="line">* ```c</span><br><span class="line">  /* Link the kernel at this address: &quot;.&quot; means the current address */</span><br><span class="line">  	. = 0xF0100000;</span><br><span class="line">  </span><br><span class="line">  	/* AT(...) gives the load address of this section, which tells</span><br><span class="line">  	   the boot loader where to load the kernel in physical memory */</span><br><span class="line">  	.text : AT(0x100000) &#123;</span><br><span class="line">  		*(.text .stub .text.* .gnu.linkonce.t.*)</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>将虚拟地址映射为物理地址</p>
</li>
<li><p>关于目前的这个系统是怎么进行内存的映射的，主要使用了cr3和cr0。</p>
<p>并且寻址方式如下：</p>
<p><img src="https://zivlnoff.github.io/graph/image-20211210174140428.png"></p>
</li>
<li><p>CR3寄存器确定了这张表的基地址（看kernel.asm没看懂那个立即数值，还是得看entry.S文件）</p>
</li>
<li><p>```asm</p>
<h1 id="Load-the-physical-address-of-entry-pgdir-into-cr3-entry-pgdir"><a href="#Load-the-physical-address-of-entry-pgdir-into-cr3-entry-pgdir" class="headerlink" title="Load the physical address of entry_pgdir into cr3.  entry_pgdir"></a>Load the physical address of entry_pgdir into cr3.  entry_pgdir</h1><h1 id="is-defined-in-entrypgdir-c"><a href="#is-defined-in-entrypgdir-c" class="headerlink" title="is defined in entrypgdir.c."></a>is defined in entrypgdir.c.</h1><p>movl   $(RELOC(entry_pgdir)), %eax<br>movl   %eax, %cr3</p>
<h1 id="Turn-on-paging"><a href="#Turn-on-paging" class="headerlink" title="Turn on paging."></a>Turn on paging.</h1><p>movl   %cr0, %eax<br>orl    $(CR0_PE|CR0_PG|CR0_WP), %eax<br>movl   %eax, %cr0</p>
<p>#define    RELOC(x) ((x) - KERNBASE)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 此时我们只有2个页目录项，索引0和0b1111000000=512+256+128+64=768+128+64=896+64=960</span><br><span class="line"></span><br><span class="line">* ```c</span><br><span class="line">  __attribute__((__aligned__(PGSIZE)))</span><br><span class="line">  pde_t entry_pgdir[NPDENTRIES] = &#123;</span><br><span class="line">  	// Map VA&#x27;s [0, 4MB) to PA&#x27;s [0, 4MB)</span><br><span class="line">  	[0]</span><br><span class="line">  		= ((uintptr_t)entry_pgtable - KERNBASE) + PTE_P,	//present</span><br><span class="line">  	// Map VA&#x27;s [KERNBASE, KERNBASE+4MB) to PA&#x27;s [0, 4MB)</span><br><span class="line">  	[KERNBASE&gt;&gt;PDXSHIFT]</span><br><span class="line">  		= ((uintptr_t)entry_pgtable - KERNBASE) + PTE_P + PTE_W	//Writable</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="解读entry函数"><a href="#解读entry函数" class="headerlink" title="解读entry函数"></a>解读entry函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">f010000c &lt;entry&gt;:</span><br><span class="line">f010000c:	66 c7 05 72 04 00 00 	movw   $0x1234,0x472</span><br><span class="line">f0100013:	34 12 </span><br><span class="line">//加载cr3寄存器 存页目录首地址</span><br><span class="line">f0100015:	b8 00 f0 10 00       	mov    $0x10f000,%eax	</span><br><span class="line">f010001a:	0f 22 d8             	mov    %eax,%cr3</span><br><span class="line">//开启分页（虚拟地址=线性地址（好像存在情况不等，以后再说）映射到物理地址）</span><br><span class="line">#define CR0_PE		0x00000001	// Protection Enable</span><br><span class="line">#define CR0_WP		0x00010000	// Write Protect</span><br><span class="line">#define CR0_PG		0x80000000	// Paging</span><br><span class="line">f010001d:	0f 20 c0             	mov    %cr0,%eax</span><br><span class="line">f0100020:	0d 01 00 01 80       	or     $0x80010001,%eax</span><br><span class="line">f0100025:	0f 22 c0             	mov    %eax,%cr0</span><br><span class="line">//跳转到relocated</span><br><span class="line">f0100028:	b8 2f 00 10 f0       	mov    $0xf010002f,%eax</span><br><span class="line">f010002d:	ff e0                	jmp    *%eax</span><br><span class="line"># ebp置为0 使得backtrace可以正常中止</span><br><span class="line"># so that once we get into debugging C code,</span><br><span class="line"># stack backtraces will be terminated properly.</span><br><span class="line">f010002f &lt;relocated&gt;:</span><br><span class="line">f010002f:	bd 00 00 00 00       	mov    $0x0,%ebp</span><br><span class="line">#设置新的ebp</span><br><span class="line">f0100034:	bc 00 f0 10 f0       	mov    $0xf010f000,%esp</span><br><span class="line">//跳转到c代码</span><br><span class="line">f0100039:	e8 56 00 00 00       	call   f0100094 &lt;i386_init&gt;</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">###################################################################</span><br><span class="line"># boot stack</span><br><span class="line">###################################################################</span><br><span class="line">	.p2align	PGSHIFT		# force page alignment</span><br><span class="line">	.globl		bootstack</span><br><span class="line">bootstack:</span><br><span class="line">	.space		KSTKSIZE</span><br><span class="line">	.globl		bootstacktop   </span><br><span class="line">bootstacktop:</span><br><span class="line"></span><br><span class="line">#define PGSHIFT		12		// log2(PGSIZE)</span><br><span class="line">#define KSTKSIZE	(8*PGSIZE)   		// size of a kernel stack</span><br></pre></td></tr></table></figure>



<h1 id="实现查看方法调用链"><a href="#实现查看方法调用链" class="headerlink" title="实现查看方法调用链"></a>实现查看方法调用链</h1><p>我们已经知道初始设定的esp=0xf010f000，以及ebp=0，进入init函数后，ebp=0xf010f000-0x4，进而实现mon_backtrace方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mon_backtrace</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, struct Trapframe *tf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> *ebp = (<span class="keyword">uint32_t</span> *) read_ebp();</span><br><span class="line">    <span class="keyword">while</span> (ebp) &#123;</span><br><span class="line">        cprintf(<span class="string">&quot;  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n&quot;</span>, ebp, *(ebp + <span class="number">1</span>), *(ebp + <span class="number">2</span>), *(ebp + <span class="number">3</span>),</span><br><span class="line">                *(ebp + <span class="number">4</span>), *(ebp + <span class="number">5</span>));</span><br><span class="line">        ebp = (<span class="keyword">uint32_t</span> *) *ebp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static inline uint32_t</span><br><span class="line">read_ebp(void)</span><br><span class="line">&#123;</span><br><span class="line">	uint32_t ebp;</span><br><span class="line">	asm volatile(&quot;movl %%ebp,%0&quot; : &quot;=r&quot; (ebp));</span><br><span class="line">	return ebp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际情况，我们想知道的是函数在哪个文件的哪个方法以及哪一行，根据手册，参考debuginfo_eip函数，可以想象必须知道用于调试的符号表信息，在kernel.ld中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* Include debugging information in kernel memory */</span><br><span class="line">.stab : &#123;</span><br><span class="line">   PROVIDE(__STAB_BEGIN__ = .);</span><br><span class="line">   *(.stab);</span><br><span class="line">   PROVIDE(__STAB_END__ = .);</span><br><span class="line">   BYTE(0)       /* Force the linker to allocate space</span><br><span class="line">            for this section */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// debuginfo_eip(addr, info)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	Fill in the &#x27;info&#x27; structure with information about the specified</span></span><br><span class="line"><span class="comment">//	instruction address, &#x27;addr&#x27;.  Returns 0 if information was found, and</span></span><br><span class="line"><span class="comment">//	negative if not.  But even if it returns negative it has stored some</span></span><br><span class="line"><span class="comment">//	information into &#x27;*info&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">debuginfo_eip</span><span class="params">(<span class="keyword">uintptr_t</span> addr, struct Eipdebuginfo *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> *<span class="title">stabs</span>, *<span class="title">stab_end</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *stabstr, *stabstr_end;</span><br><span class="line">	<span class="keyword">int</span> lfile, rfile, lfun, rfun, lline, rline;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize *info</span></span><br><span class="line">	info-&gt;eip_file = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">	info-&gt;eip_line = <span class="number">0</span>;</span><br><span class="line">	info-&gt;eip_fn_name = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">	info-&gt;eip_fn_namelen = <span class="number">9</span>;</span><br><span class="line">	info-&gt;eip_fn_addr = addr;</span><br><span class="line">	info-&gt;eip_fn_narg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find the relevant set of stabs</span></span><br><span class="line">	<span class="keyword">if</span> (addr &gt;= ULIM) &#123;</span><br><span class="line">		stabs = __STAB_BEGIN__;</span><br><span class="line">		stab_end = __STAB_END__;</span><br><span class="line">		stabstr = __STABSTR_BEGIN__;</span><br><span class="line">		stabstr_end = __STABSTR_END__;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t search for user-level addresses yet!</span></span><br><span class="line">  	        panic(<span class="string">&quot;User address&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// String table validity checks</span></span><br><span class="line">	<span class="keyword">if</span> (stabstr_end &lt;= stabstr || stabstr_end[<span class="number">-1</span>] != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now we find the right stabs that define the function containing</span></span><br><span class="line">	<span class="comment">// &#x27;eip&#x27;.  First, we find the basic source file containing &#x27;eip&#x27;.</span></span><br><span class="line">	<span class="comment">// Then, we look in that source file for the function.  Then we look</span></span><br><span class="line">	<span class="comment">// for the line number.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search the entire set of stabs for the source file (type N_SO).</span></span><br><span class="line">	lfile = <span class="number">0</span>;</span><br><span class="line">	rfile = (stab_end - stabs) - <span class="number">1</span>;</span><br><span class="line">	stab_binsearch(stabs, &amp;lfile, &amp;rfile, N_SO, addr);</span><br><span class="line">	<span class="keyword">if</span> (lfile == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search within that file&#x27;s stabs for the function definition</span></span><br><span class="line">	<span class="comment">// (N_FUN).</span></span><br><span class="line">	lfun = lfile;</span><br><span class="line">	rfun = rfile;</span><br><span class="line">	stab_binsearch(stabs, &amp;lfun, &amp;rfun, N_FUN, addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lfun &lt;= rfun) &#123;</span><br><span class="line">		<span class="comment">// stabs[lfun] points to the function name</span></span><br><span class="line">		<span class="comment">// in the string table, but check bounds just in case.</span></span><br><span class="line">		<span class="keyword">if</span> (stabs[lfun].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">			info-&gt;eip_fn_name = stabstr + stabs[lfun].n_strx;</span><br><span class="line">		info-&gt;eip_fn_addr = stabs[lfun].n_value;</span><br><span class="line">		addr -= info-&gt;eip_fn_addr;</span><br><span class="line">		<span class="comment">// Search within the function definition for the line number.</span></span><br><span class="line">		lline = lfun;</span><br><span class="line">		rline = rfun;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Couldn&#x27;t find function stab!  Maybe we&#x27;re in an assembly</span></span><br><span class="line">		<span class="comment">// file.  Search the whole file for the line number.</span></span><br><span class="line">		info-&gt;eip_fn_addr = addr;</span><br><span class="line">		lline = lfile;</span><br><span class="line">		rline = rfile;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Ignore stuff after the colon.</span></span><br><span class="line">	info-&gt;eip_fn_namelen = strfind(info-&gt;eip_fn_name, <span class="string">&#x27;:&#x27;</span>) - info-&gt;eip_fn_name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search within [lline, rline] for the line number stab.</span></span><br><span class="line">	<span class="comment">// If found, set info-&gt;eip_line to the right line number.</span></span><br><span class="line">	<span class="comment">// If not found, return -1.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Hint:</span></span><br><span class="line">	<span class="comment">//	There&#x27;s a particular stabs type used for line numbers.</span></span><br><span class="line">	<span class="comment">//	Look at the STABS documentation and &lt;inc/stab.h&gt; to find</span></span><br><span class="line">	<span class="comment">//	which one.</span></span><br><span class="line">	<span class="comment">// Your code here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search backwards from the line number for the relevant filename</span></span><br><span class="line">	<span class="comment">// stab.</span></span><br><span class="line">	<span class="comment">// We can&#x27;t just use the &quot;lfile&quot; stab because inlined functions</span></span><br><span class="line">	<span class="comment">// can interpolate code from a different file!</span></span><br><span class="line">	<span class="comment">// Such included source files use the N_SOL stab type.</span></span><br><span class="line">	<span class="keyword">while</span> (lline &gt;= lfile</span><br><span class="line">	       &amp;&amp; stabs[lline].n_type != N_SOL</span><br><span class="line">	       &amp;&amp; (stabs[lline].n_type != N_SO || !stabs[lline].n_value))</span><br><span class="line">		lline--;</span><br><span class="line">	<span class="keyword">if</span> (lline &gt;= lfile &amp;&amp; stabs[lline].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">		info-&gt;eip_file = stabstr + stabs[lline].n_strx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set eip_fn_narg to the number of arguments taken by the function,</span></span><br><span class="line">	<span class="comment">// or 0 if there was no containing function.</span></span><br><span class="line">	<span class="keyword">if</span> (lfun &lt; rfun)</span><br><span class="line">		<span class="keyword">for</span> (lline = lfun + <span class="number">1</span>;</span><br><span class="line">		     lline &lt; rfun &amp;&amp; stabs[lline].n_type == N_PSYM;</span><br><span class="line">		     lline++)</span><br><span class="line">			info-&gt;eip_fn_narg++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>![image-20211211201217776](/Users/alsc/Library/Application Support/typora-user-images/image-20211211201217776.png)</p>
<p>lab1写完我哭了啊</p>
<p>![image-20211211201251431](/Users/alsc/Library/Application Support/typora-user-images/image-20211211201251431.png)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/12/17/%E7%95%99%E4%B8%8B/" data-id="ckx9s7jze00009pm4bm388zwn" data-title="留下" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/12/16/%E5%9C%A8%E6%88%90%E9%95%BF/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">在成长</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/12/17/%E7%95%99%E4%B8%8B/">留下</a>
          </li>
        
          <li>
            <a href="/2021/12/16/%E5%9C%A8%E6%88%90%E9%95%BF/">在成长</a>
          </li>
        
          <li>
            <a href="/2021/12/15/JOS-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">JOS-内存管理</a>
          </li>
        
          <li>
            <a href="/2021/12/15/%E4%BD%A0%E6%AF%94%E8%BF%B7%E5%AE%AB%E6%9B%B4%E7%BE%8E/">你比迷宫更美</a>
          </li>
        
          <li>
            <a href="/2021/12/14/%E5%AE%9E%E4%B9%A0%E4%BF%A9%E6%9C%88%E5%86%8D%E7%9C%8Bcola/">实习俩月再看cola</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 ColvTzzi<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>